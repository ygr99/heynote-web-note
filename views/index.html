<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real-Time Notepad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- æ·»åŠ  CodeMirror ç›¸å…³ä¾èµ– -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/eclipse.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/markdown-fold.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css"
    />
    <!-- æ·»åŠ æ›´å¤š CodeMirror æ’ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/continuelist.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/mode/overlay.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/gfm/gfm.min.js"></script>
    <style>
      .CodeMirror {
        height: 100%;
        font-size: 16px;
      }
      .cm-header {
        font-weight: bold;
      }
      .block {
        border-bottom: 1px solid #eee;
      }
      .block .CodeMirror {
        height: auto;
        min-height: 50px;
      }
      /* ä¿®æ”¹ä¸»é¢˜æ ·å¼ï¼Œæ·»åŠ è¡Œå·åˆ—çš„æ ·å¼ */
      .block.theme-white .CodeMirror {
        background: white;
      }
      .block.theme-white .CodeMirror-gutters {
        background: white;
        border-right: 1px solid #ddd;
      }

      .block.theme-blue .CodeMirror {
        background: #f0f7ff;
      }
      .block.theme-blue .CodeMirror-gutters {
        background: #f0f7ff;
        border-right: 1px solid #cce0ff;
      }

      /* ç»Ÿä¸€è®¾ç½®è¡Œå·çš„é¢œè‰² */
      .CodeMirror-linenumber {
        color: #999;
      }

      /* è®¾ç½®æŠ˜å å›¾æ ‡çš„é¢œè‰² */
      .CodeMirror-foldgutter-open:after {
        color: #999;
      }
      .CodeMirror-foldgutter-folded:after {
        color: #999;
      }

      /* Markdown è¯­æ³•é«˜äº®æ ·å¼ */
      /* æ™®é€šåˆ—è¡¨ç”¨ç°è‰² */
      .CodeMirror.cm-s-eclipse .CodeMirror-code span.cm-variable-2 {
        color: #4b5563 !important;
      }

      /* ä»»åŠ¡åˆ—è¡¨ä½¿ç”¨è“è‰² - é’ˆå¯¹ä»»åŠ¡åˆ—è¡¨çš„ç‰¹æ®Šç»“æ„ */
      .CodeMirror.cm-s-eclipse
        .CodeMirror-code
        span.cm-meta
        + span.cm-variable-2 {
        color: #4b5563 !important;
      }
      .CodeMirror.cm-s-eclipse .CodeMirror-code span.cm-meta {
        color: #2563eb !important;
      }

      .cm-header-1,
      .cm-header-2,
      .cm-header-3,
      .cm-header {
        color: #2563eb;
        font-weight: normal;
        font-size: inherit;
      }

      .cm-strong {
        color: #111;
        font-weight: normal;
      }
      .cm-em {
        color: #111;
        font-style: normal;
      }

      .cm-link {
        color: #2563eb;
        text-decoration: none;
      }
      .cm-url {
        color: #60a5fa;
      }

      .cm-quote {
        color: #059669;
        font-style: normal;
      }

      .cm-variable-3 {
        color: #4b5563;
      } /* æœ‰åºåˆ—è¡¨ */

      .cm-comment {
        color: #6b7280;
        font-style: normal;
      }
      .cm-code {
        color: #ef4444;
        background: none;
        padding: 0;
        border-radius: 0;
      }

      /* ä»£ç å—æ ·å¼ */
      .cm-comment.cm-code {
        color: #059669;
        background: none;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="max-w-2xl mx-auto">
      <!-- Buttons at the top -->
      <div class="space-x-2 mb-4">
        <button
          id="blogButton"
          class="px-4 py-2 bg-pink-500 text-white rounded-lg"
        >
          Blog
        </button>
        <button
          id="insertBlockBefore"
          class="px-4 py-2 bg-blue-500 text-white rounded-lg"
        >
          Before
        </button>
        <button
          id="insertBlockAfter"
          class="px-4 py-2 bg-blue-500 text-white rounded-lg"
        >
          After
        </button>
        <button
          id="insertDate"
          class="px-4 py-2 bg-purple-500 text-white rounded-lg"
        >
          Diary
        </button>
        <button
          id="insertNote"
          class="px-4 py-2 bg-indigo-500 text-white rounded-lg"
        >
          Note
        </button>
        <button
          id="insertTime"
          class="px-4 py-2 bg-green-500 text-white rounded-lg"
        >
          Time
        </button>
        <button
          id="foldAll"
          class="px-4 py-2 bg-orange-500 text-white rounded-lg"
        >
          Fold
        </button>
      </div>

      <!-- Notepad container -->
      <div id="notepad" class="w-full h-[90vh] bg-white border overflow-y-auto">
        <!-- Blocks will be dynamically inserted here -->
      </div>
    </div>

    <script>
      const notepad = document.getElementById("notepad");
      const insertBlockBeforeButton =
        document.getElementById("insertBlockBefore");
      const insertBlockAfterButton =
        document.getElementById("insertBlockAfter");
      const insertTimeButton = document.getElementById("insertTime");
      const insertDateButton = document.getElementById("insertDate");
      const insertNoteButton = document.getElementById("insertNote");
      const foldAllButton = document.getElementById("foldAll");

      // Function to escape HTML tags
      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Load data from server
      fetch("/data")
        .then((response) => response.json())
        .then((data) => {
          if (data.blocks && data.blocks.length > 0) {
            data.blocks.forEach((block) => {
              addBlock(block.content);
            });
          } else {
            addBlock("Start typing here...");
          }
          // ç¡®ä¿åŠ è½½å®Œæ‰€æœ‰å—ååˆ·æ–°ä¸»é¢˜
          refreshBlockThemes();

          // å°†å…‰æ ‡è®¾ç½®åˆ°ç¬¬ä¸€ä¸ªå—çš„å¼€å§‹ä½ç½®
          if (editors.length > 0) {
            const firstEditor = editors[0];
            firstEditor.focus();
            firstEditor.setCursor({
              line: 0,
              ch: 0,
            });
          }
        });

      let editors = []; // å­˜å‚¨æ‰€æœ‰çš„ CodeMirror å®ä¾‹
      let activeEditor = null;

      // æ·»åŠ ä¸€ä¸ªå˜é‡æ¥è·Ÿè¸ªæŠ˜å çŠ¶æ€
      let isFolded = false;

      // ä¿®æ”¹ refreshBlockThemes å‡½æ•°
      function refreshBlockThemes() {
        const blocks = notepad.querySelectorAll(".block");
        blocks.forEach((block, index) => {
          block.className = `block ${
            index % 2 === 0 ? "theme-white" : "theme-blue"
          }`;
          editors[index].refresh();
        });
      }

      // æ·»åŠ  UUID ç”Ÿæˆå‡½æ•°
      function generateUUID() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            var r = (Math.random() * 16) | 0,
              v = c == "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      }

      // ä¿®æ”¹ saveData å‡½æ•°
      function saveData() {
        const blocks = [];
        const blockElements = notepad.querySelectorAll(".block");

        blockElements.forEach((blockDiv, index) => {
          const editor = editors[index];
          // è·å–æˆ–åˆ›å»º block çš„ id
          let blockId = blockDiv.dataset.blockId;
          if (!blockId) {
            blockId = generateUUID();
            blockDiv.dataset.blockId = blockId;
          }

          blocks.push({
            id: blockId,
            content: editor.getValue(),
            date: new Date().toISOString().split("T")[0],
          });
        });

        fetch("/data", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ blocks }),
        });
      }

      // ä¿®æ”¹ addBlock å‡½æ•°ï¼Œæ·»åŠ  id æ”¯æŒ
      function addBlock(content, referenceBlock = null, insertBefore = false) {
        const blockDiv = document.createElement("div");
        blockDiv.className = "block";
        blockDiv.dataset.blockId = generateUUID(); // ä¸ºæ–°å—ç”Ÿæˆ UUID

        const textarea = document.createElement("textarea");
        blockDiv.appendChild(textarea);

        // è·å–å‚è€ƒå—åœ¨ DOM ä¸­çš„ç´¢å¼•
        let referenceIndex = -1;
        if (referenceBlock) {
          const blocks = Array.from(notepad.querySelectorAll(".block"));
          referenceIndex = blocks.indexOf(referenceBlock);
        }

        if (referenceBlock) {
          if (insertBefore) {
            notepad.insertBefore(blockDiv, referenceBlock);
          } else {
            notepad.insertBefore(blockDiv, referenceBlock.nextSibling);
          }
        } else {
          notepad.appendChild(blockDiv);
        }

        const editor = CodeMirror.fromTextArea(textarea, {
          mode: "gfm",
          theme: "eclipse",
          lineNumbers: true,
          lineWrapping: true,
          foldGutter: true,
          gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
          foldOptions: {
            widget: (from, to) => {
              const lines = to.line - from.line;
              return lines > 0 ? ` ... ${lines} lines` : " ...";
            },
          },
          extraKeys: {
            Enter: "newlineAndIndentContinueMarkdownList",
            "Ctrl-Q": function (cm) {
              cm.foldCode(cm.getCursor());
            },
            Backspace: function (cm) {
              const cursor = cm.getCursor();
              const line = cm.getLine(cursor.line);

              if (line === "" && cursor.ch === 0) {
                if (cm.getValue().trim() === "" && editors.length > 1) {
                  const index = editors.indexOf(cm);
                  if (index > -1) {
                    editors.splice(index, 1);
                    blockDiv.remove();
                    saveData(); // åœ¨åˆ é™¤å—æ—¶ä¿å­˜

                    refreshBlockThemes();

                    if (editors.length > 0) {
                      const nextIndex = Math.min(index, editors.length - 1);
                      const nextEditor = editors[nextIndex];
                      nextEditor.focus();
                      nextEditor.setCursor({
                        line: 0,
                        ch: 0,
                      });
                    }
                  }
                  return;
                }
              }
              return CodeMirror.Pass;
            },
            Tab: function (cm) {
              if (cm.somethingSelected()) {
                cm.indentSelection("add");
              } else {
                cm.replaceSelection("  ");
              }
            },
            "Shift-Tab": function (cm) {
              cm.indentSelection("subtract");
            },
            "Ctrl-Enter": function (cm) {
              const currentBlock = cm.getWrapperElement().parentNode;
              addBlock("", currentBlock, false);
              saveData(); // åœ¨æ·»åŠ æ–°å—æ—¶ä¿å­˜
            },
            "Alt-Enter": function (cm) {
              const currentBlock = cm.getWrapperElement().parentNode;
              addBlock("", currentBlock, true);
              saveData(); // åœ¨æ·»åŠ æ–°å—æ—¶ä¿å­˜
            },
            Up: function (cm) {
              const cursor = cm.getCursor();
              if (cursor.line === 0) {
                const index = editors.indexOf(cm);
                if (index > 0) {
                  const prevEditor = editors[index - 1];
                  const lastLine = prevEditor.lastLine();
                  prevEditor.focus();
                  prevEditor.setCursor({
                    line: lastLine,
                    ch: prevEditor.getLine(lastLine).length,
                  });
                  return;
                }
              }
              return CodeMirror.Pass;
            },
            Down: function (cm) {
              const cursor = cm.getCursor();
              if (cursor.line === cm.lastLine()) {
                const index = editors.indexOf(cm);
                if (index < editors.length - 1) {
                  const nextEditor = editors[index + 1];
                  nextEditor.focus();
                  nextEditor.setCursor({
                    line: 0,
                    ch: 0,
                  });
                  return;
                }
              }
              return CodeMirror.Pass;
            },
          },
        });

        editor.setValue(content);

        // æ ¹æ®å—åœ¨ DOM ä¸­çš„ä½ç½®æ’å…¥ç¼–è¾‘å™¨
        if (referenceBlock && insertBefore) {
          editors.splice(referenceIndex, 0, editor);
        } else if (referenceBlock) {
          editors.splice(referenceIndex + 1, 0, editor);
        } else {
          editors.push(editor);
        }

        editor.on("focus", () => {
          activeEditor = editor;
        });

        editor.on("blur", () => {
          setTimeout(() => {
            if (!editors.some((ed) => ed.hasFocus())) {
              activeEditor = null;
            }
          }, 100);
        });

        editor.on("change", () => {
          saveData(); // åœ¨å†…å®¹å˜åŒ–æ—¶ä¿å­˜
        });

        editor.refresh();
        editor.focus();

        refreshBlockThemes();

        return blockDiv;
      }

      // ç”Ÿæˆæ—¥æœŸå­—ç¬¦ä¸²çš„å‡½æ•°
      function getFormattedDate() {
        const timestamp = Date.now();
        const date = new Date(timestamp);

        const year = date.getFullYear();
        const month = date.getMonth() + 1; // getMonth() è¿”å›çš„æœˆä»½æ˜¯ä» 0 å¼€å§‹çš„ï¼Œæ‰€ä»¥éœ€è¦ +1
        const day = date.getDate().toString().padStart(2, "0"); // ç¡®ä¿æ—¥æœŸæ˜¯ä¸¤ä½æ•°
        const dayOfWeek = date.getDay(); // è·å–æ˜ŸæœŸå‡ ï¼Œè¿”å›å€¼æ˜¯ 0 åˆ° 6

        // å®šä¹‰æ˜ŸæœŸæ•°ç»„
        const weekDay = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];

        // è·å–æ˜ŸæœŸçš„åç§°
        const weekDayName = weekDay[dayOfWeek];

        // è·å–ä»Šå¹´ç¬¬å‡ å¤©
        const startOfYear = new Date(year, 0, 1);
        const dayOfYear = Math.ceil(
          (date - startOfYear) / (1000 * 60 * 60 * 24)
        );

        // è·å–æœ¬å¹´åº¦ç¬¬å‡ å‘¨
        const weekNumber = Math.floor((dayOfYear - 1) / 7) + 1;

        // æ ¼å¼åŒ–æ—¥æœŸå­—ç¬¦ä¸²
        return `# ğŸ“† ${year}å¹´${month}æœˆ${day}æ—¥ å‘¨${weekDayName}${weekNumber}å‘¨`;
      }

      // æ·»åŠ æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
      function getFormattedTime() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, "0");
        const minutes = now.getMinutes().toString().padStart(2, "0");
        return `${hours}:${minutes}`;
      }

      // Insert a new block before the current block
      insertBlockBeforeButton.addEventListener("click", () => {
        if (activeEditor) {
          const currentBlock = activeEditor.getWrapperElement().parentNode;
          addBlock("", currentBlock, true);
        } else if (notepad.firstElementChild) {
          // å¦‚æœæ²¡æœ‰æ´»åŠ¨çš„ç¼–è¾‘å™¨ä½†æœ‰å—å­˜åœ¨ï¼Œåœ¨ç¬¬ä¸€ä¸ªå—ä¹‹å‰æ·»åŠ 
          addBlock("", notepad.firstElementChild, true);
        } else {
          // å¦‚æœæ²¡æœ‰ä»»ä½•å—ï¼Œç›´æ¥æ·»åŠ ä¸€ä¸ªæ–°å—
          addBlock("");
        }
      });

      // Insert a new block after the current block
      insertBlockAfterButton.addEventListener("click", () => {
        if (activeEditor) {
          const currentBlock = activeEditor.getWrapperElement().parentNode;
          addBlock("", currentBlock, false);
        } else if (notepad.lastElementChild) {
          // å¦‚æœæ²¡æœ‰æ´»åŠ¨çš„ç¼–è¾‘å™¨ä½†æœ‰å—å­˜åœ¨ï¼Œåœ¨æœ€åä¸€ä¸ªå—ä¹‹åæ·»åŠ 
          addBlock("", notepad.lastElementChild, false);
        } else {
          // å¦‚æœæ²¡æœ‰ä»»ä½•å—ï¼Œç›´æ¥æ·»åŠ ä¸€ä¸ªæ–°å—
          addBlock("");
        }
      });

      // Insert current time at the cursor position
      insertTimeButton.addEventListener("click", () => {
        if (activeEditor) {
          const timeString = getFormattedTime() + " ";
          const cursor = activeEditor.getCursor();
          activeEditor.replaceRange(timeString, cursor);
          activeEditor.focus();
        }
      });

      // Insert current date at the cursor position
      insertDateButton.addEventListener("click", () => {
        if (activeEditor) {
          const dateString = getFormattedDate() + " ";
          const cursor = activeEditor.getCursor();
          activeEditor.replaceRange(dateString, cursor);
          activeEditor.focus();
        }
      });

      // Insert note at the cursor position
      insertNoteButton.addEventListener("click", () => {
        if (activeEditor) {
          const noteString = "# ğŸ“˜ ";
          const cursor = activeEditor.getCursor();
          activeEditor.replaceRange(noteString, cursor);
          activeEditor.focus();
        }
      });

      // ä¿®æ”¹æŠ˜å æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      foldAllButton.addEventListener("click", () => {
        isFolded = !isFolded; // åˆ‡æ¢çŠ¶æ€

        editors.forEach((editor) => {
          const lineCount = editor.lineCount();

          for (let i = 0; i < lineCount; i++) {
            const line = editor.getLine(i);
            // å¦‚æœæ˜¯ä¸€çº§æ ‡é¢˜ï¼ˆä»¥å•ä¸ª # å¼€å¤´ï¼‰
            if (line.trim().match(/^#\s+/)) {
              if (isFolded) {
                // æŠ˜å 
                editor.foldCode({ line: i, ch: 0 }, null, "fold");
              } else {
                // å±•å¼€
                editor.foldCode({ line: i, ch: 0 }, null, "unfold");
              }
            }
          }
        });

        // æ›´æ–°æŒ‰é’®æ–‡æœ¬
        foldAllButton.textContent = isFolded ? "Unfold" : "Fold";
      });

      // æ·»åŠ  Blog æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      const blogButton = document.getElementById("blogButton");
      blogButton.addEventListener("click", () => {
        window.location.href = "blog.html";
      });
    </script>
  </body>
</html>
